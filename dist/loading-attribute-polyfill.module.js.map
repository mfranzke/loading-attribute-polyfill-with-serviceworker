{"version":3,"file":"loading-attribute-polyfill.module.js","sources":["../src/loading-attribute-polyfill.js"],"sourcesContent":["navigator.serviceWorker.addEventListener('message', (event) => {\n\tconsole.log(event.data.msg, event.data.url);\n});\n\n/*\n * Loading attribute polyfill - https://github.com/mfranzke/loading-attribute-polyfill-with-serviceworker\n * @license Copyright(c) 2019 by Maximilian Franzke\n * Credits for the initial kickstarter / script to @Sora2455, and supported by @cbirdsong, @eklingen, @DaPo, @nextgenthemes, @diogoterremoto, @dracos, @Flimm, @TomS-, @vinyfc93, @JordanDysart and @denyshutsal - many thanks for that !\n */\n/*\n * A minimal and dependency-free vanilla JavaScript loading attribute polyfill.\n * Supports standard's functionality and tests for native support upfront.\n * Elsewhere the functionality gets emulated with the support of ServiceWorker.\n */\n\nimport './loading-attribute-polyfill.css';\n\nconst config = {\n\tintersectionObserver: {\n\t\t// Start download if the item gets within 256px in the Y axis\n\t\trootMargin: '0px 0px 256px 0px',\n\t\tthreshold: 0.01,\n\t},\n\tlazyImage: 'img[loading=\"lazy\"]',\n\tlazyIframe: 'iframe[loading=\"lazy\"]',\n};\n\n// Device/browser capabilities object\nconst capabilities = {\n\tloading: {\n\t\timage: 'loading' in HTMLImageElement.prototype,\n\t\tiframe: 'loading' in HTMLIFrameElement.prototype,\n\t},\n\tscrolling: 'onscroll' in window,\n};\n\n// Nodelist foreach polyfill / source: https://developer.mozilla.org/en-US/docs/Web/API/NodeList/forEach#polyfill\nif (window.NodeList && !NodeList.prototype.forEach) {\n\tNodeList.prototype.forEach = Array.prototype.forEach;\n}\n\n// Define according to browsers support of the IntersectionObserver feature (missing e.g. on IE11 or Safari 11)\nlet intersectionObserver;\n\nif ('IntersectionObserver' in window) {\n\tintersectionObserver = new IntersectionObserver(\n\t\tonIntersection,\n\t\tconfig.intersectionObserver\n\t);\n}\n\n/**\n * Remove the URL query parts for the lazy loaded item\n * @param {String} urlString The URL to remove the URL query parts from\n */\nfunction removeLazyPolyfillURLParts(urlString) {\n\tlet url = new URL(urlString),\n\t\tparams = url.searchParams;\n\n\tparams.delete('loading');\n\tparams.delete('image-width');\n\tparams.delete('image-height');\n\n\treturn url.href;\n}\n\n/**\n * Remove the lazy query from the URL - now that the regular elements URL is referenced within the document, it will load now\n * @param {Object} lazyItem Current item to be referenced after lazy loading.\n */\nfunction createRegularReference(lazyItem) {\n\tconsole.log('createRegularReference');\n\n\tlet mediaItems = [lazyItem];\n\n\t// Just in case the img is the decendent of a picture element, check for source tags\n\tif (lazyItem.parentNode.tagName.toLowerCase() === 'picture') {\n\t\tmediaItems = Array.prototype.slice.call(\n\t\t\tlazyItem.parentNode.querySelectorAll('source')\n\t\t);\n\t}\n\n\tmediaItems.push(lazyItem);\n\n\tmediaItems.forEach((item) => {\n\t\tconsole.log('mediaItems', 'item', item);\n\n\t\t// TODO: We would need to refactor this part\n\t\t// if (item.hasAttribute('srcset')) {\n\t\t// \titem.srcset = removeLazyPolyfillURLParts(item.srcset);\n\t\t// }\n\t\tif (item.hasAttribute('src')) {\n\t\t\titem.src = removeLazyPolyfillURLParts(item.src);\n\t\t}\n\n\t\t// Modify the data attribute on the current status\n\t\titem.dataset.loadingLazy = 'loading';\n\t});\n}\n\n/**\n * Handle IntersectionObservers callback\n * @param {Object} entries Target elements Intersection observed changes\n * @param {Object} observer IntersectionObserver instance reference\n */\nfunction onIntersection(entries, observer) {\n\tentries.forEach((entry) => {\n\t\t// Mitigation for EDGE lacking support of .isIntersecting until v15, compare to e.g. https://github.com/w3c/IntersectionObserver/issues/211#issuecomment-309144669\n\t\tif (entry.intersectionRatio === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If the item is visible now, load it and stop watching it\n\t\tconst lazyItem = entry.target;\n\n\t\tobserver.unobserve(lazyItem);\n\n\t\tcreateRegularReference(lazyItem);\n\t});\n}\n\n/**\n * Handle printing the page\n */\nfunction onPrinting() {\n\tif (typeof window.matchMedia === 'undefined') {\n\t\treturn;\n\t}\n\n\tconst mediaQueryList = window.matchMedia('print');\n\n\tmediaQueryList.addListener((mql) => {\n\t\tif (mql.matches) {\n\t\t\tdocument\n\t\t\t\t.querySelectorAll(config.lazyImage + ',' + config.lazyIframe)\n\t\t\t\t.forEach((lazyItem) => {\n\t\t\t\t\tcreateRegularReference(lazyItem);\n\t\t\t\t});\n\t\t}\n\t});\n}\n\n/**\n * Retrieve the image and iframe 'lazy load' elements and prepare them for display\n * @param {Object} mediaTag image or iframe HTML tag\n */\nfunction prepareElement(mediaTag) {\n\tif (\n\t\t((mediaTag.tagName?.toLowerCase() === 'img' ||\n\t\t\tmediaTag.tagName?.toLowerCase() === 'picture') &&\n\t\t\t!capabilities.loading.image) ||\n\t\t(mediaTag.tagName?.toLowerCase() === 'iframe' &&\n\t\t\t!capabilities.loading.iframe)\n\t) {\n\t\tif (typeof intersectionObserver !== 'undefined') {\n\t\t\tconst observedElement = mediaTag;\n\n\t\t\t// Modify the data attribute on the current status\n\t\t\tobservedElement.dataset.loadingLazy = 'registered';\n\n\t\t\t// Observe the item so that loading could start when it gets close to the viewport\n\t\t\tintersectionObserver.observe(observedElement);\n\t\t} else {\n\t\t\tcreateRegularReference(mediaTag);\n\t\t}\n\t}\n}\n\n/**\n * Get all the img and iframe lazy loading tags on the page, prepare each and any one of them and setup the printing\n */\nconst prepareElements = () => {\n\tconst lazyLoadAreas = document.querySelectorAll(\n\t\tconfig.lazyImage + ',' + config.lazyIframe\n\t);\n\n\tlazyLoadAreas.forEach((element) => prepareElement(element));\n\n\t// Bind for someone printing the page\n\tonPrinting();\n};\n\n// If the page has loaded already, run setup - if it hasn't, run as soon as it has.\n// document.readyState values: https://www.w3schools.com/jsref/prop_doc_readystate.asp\nif (/comp|inter/.test(document.readyState)) {\n\tprepareElements();\n} else if ('addEventListener' in document) {\n\tdocument.addEventListener('DOMContentLoaded', () => {\n\t\tprepareElements();\n\t});\n} else {\n\tdocument.attachEvent('onreadystatechange', () => {\n\t\tif (document.readyState === 'complete') {\n\t\t\tprepareElements();\n\t\t}\n\t});\n}\n\nconst loadingAttributePolyfill = {\n\tprepareElement,\n};\n\nexport default loadingAttributePolyfill;\n"],"names":["navigator","serviceWorker","addEventListener","event","console","log","data","msg","url","capabilities","HTMLImageElement","prototype","HTMLIFrameElement","intersectionObserver","createRegularReference","lazyItem","mediaItems","parentNode","tagName","toLowerCase","Array","slice","call","querySelectorAll","push","forEach","item","hasAttribute","src","urlString","URL","params","searchParams","delete","href","removeLazyPolyfillURLParts","dataset","loadingLazy","prepareElement","mediaTag","observedElement","observe","window","NodeList","IntersectionObserver","entries","observer","entry","intersectionRatio","target","unobserve","rootMargin","threshold","prepareElements","document","config","element","matchMedia","addListener","mql","matches","test","readyState","attachEvent","loadingAttributePolyfill"],"mappings":"AAAAA,UAAUC,cAAcC,iBAAiB,UAAYC,IACpDC,QAAQC,IAAIF,EAAMG,KAAKC,IAAKJ,EAAMG,KAAKE,OAgBxC,MAWMC,EAEG,YAAaC,iBAAiBC,UAFjCF,EAGI,YAAaG,kBAAkBD,UAWzC,IAAIE,EA4BJ,SAASC,EAAuBC,GAC/BX,QAAQC,IAAI,0BAEZ,IAAIW,EAAa,CAACD,GAGgC,YAA9CA,EAASE,WAAWC,QAAQC,gBAC/BH,EAAaI,MAAMT,UAAUU,MAAMC,KAClCP,EAASE,WAAWM,iBAAiB,YAIvCP,EAAWQ,KAAKT,GAEhBC,EAAWS,QAASC,IACnBtB,QAAQC,IAAI,aAAc,OAAQqB,GAM9BA,EAAKC,aAAa,SACrBD,EAAKE,IArCR,SAAoCC,GACnC,IAAIrB,EAAM,IAAIsB,IAAID,GACjBE,EAASvB,EAAIwB,aAMd,OAJAD,EAAOE,OAAO,WACdF,EAAOE,OAAO,eACdF,EAAOE,OAAO,gBAEPzB,EAAI0B,KA6BEC,CAA2BT,EAAKE,MAI5CF,EAAKU,QAAQC,YAAc,YAkD7B,SAASC,EAAeC,aACvB,IACuC,kBAApCA,EAASrB,kBAASC,gBACiB,sBAApCoB,EAASrB,kBAASC,kBACjBV,GACmC,qBAApC8B,EAASrB,kBAASC,iBACjBV,EAEF,QAAoC,IAAzBI,EAAsC,CAChD,MAAM2B,EAAkBD,EAGxBC,EAAgBJ,QAAQC,YAAc,aAGtCxB,EAAqB4B,QAAQD,QAE7B1B,EAAuByB,GAlIAG,OAItBA,OAAOC,WAAaA,SAAShC,UAAUc,UAC1CkB,SAAShC,UAAUc,QAAUL,MAAMT,UAAUc,SAM1C,yBAA0BiB,SAC7B7B,EAAuB,IAAI+B,qBA4D5B,SAAwBC,EAASC,GAChCD,EAAQpB,QAASsB,IAEhB,GAAgC,IAA5BA,EAAMC,kBACT,OAID,MAAMjC,EAAWgC,EAAME,OAEvBH,EAASI,UAAUnC,GAEnBD,EAAuBC,MAnGF,CAErBoC,WAAY,oBACZC,UAAW,OAsJb,MAAMC,EAAkB,KACDC,SAAS/B,iBAC9BgC,8CAGa9B,QAAS+B,GAAYlB,EAAekB,SAnDjB,IAAtBd,OAAOe,YAIKf,OAAOe,WAAW,SAE1BC,YAAaC,IACvBA,EAAIC,SACPN,SACE/B,iBAAiBgC,8CACjB9B,QAASV,IACTD,EAAuBC,QAgDxB,aAAa8C,KAAKP,SAASQ,YAC9BT,IACU,qBAAsBC,SAChCA,SAASpD,iBAAiB,mBAAoB,KAC7CmD,MAGDC,SAASS,YAAY,qBAAsB,KACd,aAAxBT,SAASQ,YACZT,MAKGW,MAAAA,EAA2B,CAChC1B,eAAAA"}